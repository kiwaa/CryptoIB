
@{
    ViewData["Title"] = "Market Data";
}

<div id="chart"></div>

<div class="row" style="margin: 20px 0 20px 0">
    <div class="table-responsive">
        <table id="market-data" class="table table-striped ">
            <tr>
                <th>Status</th>
                <th>Exchange</th>
                <th>Pair</th>
                <th>Bid</th>
                <th>Ask</th>
            </tr>
        </table>
    </div>
</div>



@section Scripts {
    <script src="~/lib/d3/d3.js"></script>
    <script src="~/lib/techan/dist/techan.js"></script>
    <script src="~/js/candlestick.js" asp-append-version="true"></script>

    <script>
        var ohlc = [];
        var transportType = signalR.TransportType.WebSockets;
        var http = new signalR.HttpConnection(`http://${document.location.host}/quotes`, { transport: transportType });

        var logger = new signalR.ConsoleLogger(signalR.LogLevel.Information);
        var connection = new signalR.HubConnection(http);

        connection.on('New',
            (data) => {
                if (data.Quote) {
                    appendLine(data.Quote);
                }

                if (data.Ohlc) {
                    var d = {
                        date: new Date(data.Ohlc.Date),
                        open: data.Ohlc.Open,
                        high: data.Ohlc.High,
                        low: data.Ohlc.Low,
                        close: data.Ohlc.Close
                    };
                    ohlc.push(d);
                    draw(ohlc);
                }
            });

        connection.on('List',
            (data) => {
                ohlc = data.map(d => {
                    return {
                        date: new Date(d.Date),
                        open: d.Open,
                        high: d.High,
                        low: d.Low,
                        close: d.Close
                    }
                });
                init(ohlc);
            });

        connection.start();

        function appendLine(quote) {
            var tr = buildRow(quote);

            var node = $("#" + getId(quote));
            if (node.length) {
                node.replaceWith(tr);
            } else {
                $("#market-data").append(tr);
            }
        };


        function buildRow(quote) {
            var tr = $("<tr/>").attr("id", getId(quote)).append(
                $("<td/>").text(quote.Status),
                $("<td/>").text(quote.Exchange),
                $("<td/>").text(quote.Pair),
                $("<td/>").text(quote.Bid),
                $("<td/>").text(quote.Ask)
            );
            return tr;
        }

        function getId(quote) {
            return (quote.Exchange + "-" + quote.Pair.replace("/", "-")).toLowerCase();
        }

    </script>
}